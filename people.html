---
layout: layout.html
---

<div id="people">
</div>

<div id="photos">
</div>

<script type="text/template" id="people-template">
  <h1>People</h1>
  <ul>
  {{#people}}
    <li>
      <a href="/people/{{username}}">{{ username }}</a>, joined {{ joined }}
    </li>
  {{/people}}
  </ul>
</script>

<script type="text/template" id="person-template">
  <h1>{{username}}</h1>
  <p>joined {{ joined }}</p>
  {{#follows}}
  <div>
    Follows
    <ul class="follows">
      {{#follows}}
        <li><a href="/people/{{.}}">{{.}}</a></li>
      {{/follows}}
    </ul>
  </div>
  {{/follows}}
</script>

<script type="text/template" id="photos-template">
  {{#photos}}
  <img src="/data/images/{{username}}/{{image}}" style="width: 200px; height: 200px;"/>
  {{/photos}}
</script>

<script>

  var showPeople = function() {
    var template = Hogan.compile(document.getElementById('people-template').innerText)
    fetch('/data/profiles.json')
      .then(function(res) { return res.json() })
      .then(function(data) {
        var profiles = Object.values(data)
        profiles.forEach(function(p) {
          p.joined = fecha.format(new Date(p.joined), 'mediumDate')
        })
        console.log("profiles:", profiles)
        document.getElementById('people').innerHTML = template.render({ people: profiles })
      })
      .catch(function(err) { handleError(err, "Error loading profiles") })
  }

  var showPerson = function(username) {
    var template = Hogan.compile(document.getElementById('person-template').innerText)
    var photosTemplate = Hogan.compile(document.getElementById('photos-template').innerText)

    // render profile stuff
    fetch('/data/profiles/'+username+'.json')
      .then(function(res) { return res.json() })
      .then(function(person) {
        fetch('/data/follows/'+username+'/follows.json')
          .then(function(res) { return res.status === 200 ? res.json() : null })
          .then(function(follows) {
            person.follows = follows || []
            person.joined = fecha.format(new Date(person.joined), 'mediumDate')
            document.getElementById('people').innerHTML = template.render(person)
          })
      })
      .catch(function(err) { handleError(err, "Error loading person") })

    // render person's photos
    fetch('/data/photos/'+username+'.json')
      .then(function(res) {
        return res.status === 200 ? res.json() : null
      })
      .then(function(json) {
        if (!json) return
        var photos = Object.values(json)
        document.getElementById('photos').innerHTML = photosTemplate.render({ photos: photos, username: username })
      })
      .catch(function(err) { handleError(err, "Error loading photos") })
  }

  // check to see if we're listing all people, or if it's a single person's page
  if (window.location.pathname === '/people') {
    showPeople()
  } else {
    showPerson(window.location.pathname.split('/').pop())
  }

</script>
